<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>[Scala] Future#recoverを使って例外処理する - kobtea.net</title>
    <meta name="description" content="eternal jojaku">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <link rel="stylesheet" href="https://kobtea.net/css/capybara.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
</head>

<body>
<header>
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                        data-target="#header-navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="https://kobtea.net">kobtea.net</a>

                <p class="navbar-text">eternal jojaku</p>
            </div>

            <div class="collapse navbar-collapse" id="header-navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    
                    <li><a href="/posts">archives</a></li>
                    
                    <li><a href="/posts/index.xml">rss</a></li>
                    
                </ul>
            </div>
        </div>
    </nav>
</header>


<article class="container-fluid">
    <div class="page-header">
        <h1><a href="https://kobtea.net/posts/2015/05/18/scala-future-recover/">[Scala] Future#recoverを使って例外処理する</a></h1>
        <time pubdate datetime=" 2015-05-18 " title="2015-05-18">2015-05-18</time>
        
        <a href="/tags/scala">
            <button type="button" class="btn btn-default btn-xs">scala</button>
        </a>
        
        <div class="toc">
            <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#環境">環境</a></li>
<li><a href="#やりたいこと">やりたいこと</a></li>
<li><a href="#recoverを使う">recoverを使う</a></li>
<li><a href="#recoverwithを使う">recoverWithを使う</a></li>
</ul></li>
</ul>
</nav>
        </div>
    </div>

    

<h2 id="環境">環境</h2>

<pre><code>➜  ~  scala
Welcome to Scala version 2.11.6 (Java HotSpot(TM) 64-Bit Server VM, Java 1.8.0_11).
Type in expressions to have them evaluated.
Type :help for more information.
</code></pre>

<h2 id="やりたいこと">やりたいこと</h2>

<p><code>scala.concurrent.Future</code>で例外が発生して<code>Failure</code>になったとき、</p>

<ul>
<li>デフォルト値を適用して<code>Success</code>で返したい！<br /></li>
<li><code>Failure</code>のままでいいんだけど別の例外を投げたい！<br />
<br /></li>
</ul>

<p>といったことをしたい。</p>

<h2 id="recoverを使う">recoverを使う</h2>

<p>そんなときのための<code>Future#recover</code>。<br />
<code>Throwable</code>をキャッチして新しい<code>Future</code>を作ってくれる。</p>

<p>シグネチャは以下。</p>

<pre><code class="language-scala">def recover[U &gt;: T](pf: PartialFunction[Throwable, U])(implicit executor: ExecutionContext): Future[U]
</code></pre>

<p>ソースは<a href="https://github.com/scala/scala/blob/v2.11.6/src/library/scala/concurrent/Future.scala#L310-L326">この辺</a>。</p>

<p>下準備</p>

<pre><code class="language-scala">scala&gt; import scala.concurrent.Future
import scala.concurrent.Future

scala&gt; import scala.concurrent.ExecutionContext.Implicits.global
import scala.concurrent.ExecutionContext.Implicits.global

scala&gt; case class MyException() extends Exception
defined class MyException
</code></pre>

<p>サンプル</p>

<pre><code class="language-scala">// まずはそのまま実行してみる
scala&gt; Future {
     |   throw new IllegalArgumentException()
     | }
res0: scala.concurrent.Future[Nothing] = scala.concurrent.impl.Promise$DefaultPromise@b59d31

scala&gt; res0.value.get
res1: scala.util.Try[Nothing] = Failure(java.lang.IllegalArgumentException)


// デフォルト値を適用したい！
scala&gt; Future {
     |   throw new IllegalArgumentException()
     | } recover {
     |   case e: IllegalArgumentException =&gt; 0
     | }
res2: scala.concurrent.Future[Int] = scala.concurrent.impl.Promise$DefaultPromise@2e1d27ba

scala&gt; res2.value.get
res3: scala.util.Try[Int] = Success(0)


// 別の例外を投げたい！
scala&gt; Future {
     |   throw new IllegalArgumentException()
     | } recover {
     |   case e: IllegalArgumentException =&gt; throw MyException()
     | }
res4: scala.concurrent.Future[Nothing] = scala.concurrent.impl.Promise$DefaultPromise@3bcd05cb

scala&gt; res4.value.get
res5: scala.util.Try[Nothing] = Failure(MyException)


// Successなときはそのままの結果
scala&gt; Future {
     |   10
     | } recover {
     |   case e: IllegalArgumentException =&gt; throw MyException()
     | }
res6: scala.concurrent.Future[Int] = scala.concurrent.impl.Promise$DefaultPromise@56928307

scala&gt; res6.value.get
res7: scala.util.Try[Int] = Success(10)
</code></pre>

<h2 id="recoverwithを使う">recoverWithを使う</h2>

<p><code>Future#recoverWith</code>なんていうのもある。<br />
<code>Future#recover</code>とは部分関数の型が違って、<code>Throwable</code>を受け取って<code>Future</code>を返すようになる。</p>

<p>シグネチャは以下。</p>

<pre><code class="language-scala">def recoverWith[U &gt;: T](pf: PartialFunction[Throwable, Future[U]])(implicit executor: ExecutionContext): Future[U]
</code></pre>

<p>ソースは<a href="https://github.com/scala/scala/blob/v2.11.6/src/library/scala/concurrent/Future.scala#L328-L348">この辺</a>。</p>

<p>サンプル</p>

<pre><code class="language-scala">// デフォルト値を適用したい！
scala&gt; Future {
     |   throw new IllegalArgumentException()
     | } recoverWith {
     |   case e: IllegalArgumentException =&gt; Future.successful(0)
     | }
res8: scala.concurrent.Future[Int] = scala.concurrent.impl.Promise$DefaultPromise@463b4ac8

scala&gt; res8.value.get
res9: scala.util.Try[Int] = Success(0)


// 別の例外を投げたい！
// これは特に変わらず
scala&gt; Future {
     |   throw new IllegalArgumentException()
     | } recover {
     |   case e: IllegalArgumentException =&gt; throw MyException()
     | }
res10: scala.concurrent.Future[Nothing] = scala.concurrent.impl.Promise$DefaultPromise@4a3e3e8b

scala&gt; res10.value.get
res11: scala.util.Try[Nothing] = Failure(MyException)


// Successなときはそのままの結果
scala&gt; Future {
     |   10
     | } recoverWith {
     |   case e: IllegalArgumentException =&gt; Future.successful(0)
     | }
res12: scala.concurrent.Future[Int] = scala.concurrent.impl.Promise$DefaultPromise@6a1ebcff

scala&gt; res12.value.get
res13: scala.util.Try[Int] = Success(10)
</code></pre>


    <hr/>

    <div id="disqus_thread"></div>
    <script type="text/javascript">
         
        var disqus_shortname = 'kobtea';

         
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</article>

<nav class="container-fluid">
    <ul class="pager">
        
        <li class="previous"><a href="https://kobtea.net/posts/2015/08/22/yapc-isucon/"><i class="fa fa-caret-left"></i> YAPC::Asia Tokyo 2015 「ISUCONの勝ち方」メモ</a></li>
        

        
        <li class="next"><a href="https://kobtea.net/posts/2015/03/28/java-printflagsfinal/">Java Optionの一覧表示 <i class="fa fa-caret-right"></i></a></li>
        
    </ul>
</nav>


<footer>
    <div class="container-fluid">
        <div class="row">

            <div class="col-md-4">
                <strong>Author</strong>
                <div class="media">
                    <div class="media-left media-top">
                        <img src="http://www.gravatar.com/avatar/0341c09395fd77b2a42ee5f8f681c24d.png">
                    </div>
                    <div class="media-body">
                        <strong class="media-heading">kobtea</strong>
                        <a href="https://twitter.com/kobtea"><i class="fa fa-twitter-square fa-lg"></i></a>
                        <a href="https://github.com/kobtea"><i class="fa fa-github-square fa-lg"></i></a>
                        <br/>
                        <small>カピバラと暮らしたい</small>
                    </div>
                </div>
            </div>

            

            <div class="col-md-8">
                <strong> Tags </strong><br/><br/>
                
                <a href="/tags/book"><button type="button" class="btn btn-default btn-xs">book</button></a>
                
                <a href="/tags/conference"><button type="button" class="btn btn-default btn-xs">conference</button></a>
                
                <a href="/tags/gcp"><button type="button" class="btn btn-default btn-xs">gcp</button></a>
                
                <a href="/tags/github-pages"><button type="button" class="btn btn-default btn-xs">github-pages</button></a>
                
                <a href="/tags/hardware"><button type="button" class="btn btn-default btn-xs">hardware</button></a>
                
                <a href="/tags/java"><button type="button" class="btn btn-default btn-xs">java</button></a>
                
                <a href="/tags/markdown"><button type="button" class="btn btn-default btn-xs">markdown</button></a>
                
                <a href="/tags/misc"><button type="button" class="btn btn-default btn-xs">misc</button></a>
                
                <a href="/tags/monitoring"><button type="button" class="btn btn-default btn-xs">monitoring</button></a>
                
                <a href="/tags/octopress"><button type="button" class="btn btn-default btn-xs">octopress</button></a>
                
                <a href="/tags/opengrok"><button type="button" class="btn btn-default btn-xs">opengrok</button></a>
                
                <a href="/tags/python"><button type="button" class="btn btn-default btn-xs">python</button></a>
                
                <a href="/tags/ruby"><button type="button" class="btn btn-default btn-xs">ruby</button></a>
                
                <a href="/tags/scala"><button type="button" class="btn btn-default btn-xs">scala</button></a>
                
                <a href="/tags/vim"><button type="button" class="btn btn-default btn-xs">vim</button></a>
                
                <a href="/tags/windows"><button type="button" class="btn btn-default btn-xs">windows</button></a>
                
            </div>

        </div>
        <p>&copy; 2015 kobtea | Powered by <a href="http://gohugo.io/">HUGO</a> | Themed with <a
                href="https://github.com/kobtea/hugo-theme-capybara">Capybara</a></p>
    </div>
</footer>
<script src="https://kobtea.net/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-60750954-1', 'auto');
    ga('send', 'pageview');
</script>

</body>
</html>
